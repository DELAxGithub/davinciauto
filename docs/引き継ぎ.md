引き継ぎメモ（Orion / 自動化ツール一式）
========================================

更新日: 2025-02-XX  
最終作業者: Codex (補助)

このリポジトリで扱う主要なワークフローは以下の3系統です。各章に周辺ファイル位置と運用メモ、未解決タスクをまとめました。

1. Premiere Pro オートカット（FCPXML 自動生成）
2. TTS パイプライン（Gemini TTS + Google TTS ハイブリッド）
3. DaVinci Resolve 画像タグ運用（メタデータ設計）

---

1. Premiere オートカット
------------------------

- コードベース  
  - 仕様: `projects/nle_autoedit/specs/README.md` と配下の `common/`, `premiere/`, `resolve/`  
  - 実装基盤: `projects/nle_autoedit/common/` の Python モジュール（タイムライン生成ロジック）
- 想定データフロー  
  1. 台本 → CSV（`*_timeline.csv`）を作成。`scripts/run_tts_pipeline.py` を回すと `output/` に自動生成される。  
  2. CSV とテンプレート YAML/JSON を `nle_autoedit` のビルダーに渡して FCPXML を出力。  
  3. Premiere/Resolve 双方で同じ XML を読み込める設計（`specs/common/data_contract.md` 参照）。  
  4. Premiere 側は CEP/UXP パネル、Resolve 側はスクリプトで最終実装予定（`specs/premiere/panel_spec.md` / `specs/resolve/script_spec.md`）。
- 現状ステータス  
  - CSV→FCPXML のコアロジックは共通モジュールに実装済み。UI（パネル/スクリプト）は未完成。  
  - ラベル名の正規化やギャップテロップ処理などは `data_contract.md` にルールあり。最新版を必ず確認。  
  - Premiere 自動カット用テンプレートの棚卸しが未実施。`templates/` にドラフトがあるので見直し要。
- 引き継ぎタスク  
  - [ ] `nle_autoedit` モジュールを CLI 化 or 既存 CLI の確認（未ドキュメント）。  
  - [ ] Premiere パネル / Resolve スクリプトの UI 実装ステータスを確認（該当ディレクトリはまだ空）。  
  - [ ] テンプレ宣言 YAML の最新仕様をドキュメント化し、番組別差分を整理。

---

2. TTS パイプライン
--------------------

- メインスクリプト: `scripts/run_tts_pipeline.py`  
  - 依存モジュール: `scripts/orion_tts_generator.py`, `scripts/srt_merge.py`, `scripts/orion_ssml_builder.py` など  
  - 主要設定: `experiments/tts_config/global.yaml` + 各話 `projects/OrionEpXX/inputs/*_tts.yaml`
- 入力一式（Ep12 例）  
  - Markdown 台本: `projects/OrionEp12/inputs/orinonep12.md`  
  - ナレ台本（SSML）: `projects/OrionEp12/inputs/ep12nare` / `ep12nareyaml`  
  - 元 SRT（仮タイムコード）: `projects/OrionEp12/inputs/ep12.srt`
- 実行例（Python 3.11 必須）  
  ```bash
  python3.11 scripts/run_tts_pipeline.py \
      --project OrionEp12 \
      --script-md projects/OrionEp12/inputs/orinonep12.md \
      --script-csv projects/OrionEp12/inputs/orion_ep12_script.csv
  ```
  - 省略時は `inputs/` 内の既定ファイル名を自動検出。  
  - `--skip-csv --skip-xml` でタイムライン CSV / XML を省略可能（Ep12 最終調整で使用）。
- 生成物（既定）  
  - 音声: `projects/OrionEpXX/output/audio/OrionEpXX_###.mp3`  
  - タイムコード SRT: `projects/OrionEpXX/output/OrionEpXX_timecode.srt`  
  - マージ済み SRT: `projects/OrionEpXX/exports/orion_epXX_merged.srt`
- 現状の留意点  
  - 2025-02-XX: Ep11 のタイムライン CSV（`prototype/orion-v2/projects/OrionEp11/output/OrionEp11_timeline.csv`）を ffprobe ベースで再計測し、クリップ尺・SRT 時間を全件更新。`projects/OrionEp11/output/OrionEp11_timeline_for_xml.csv` → `projects/OrionEp11/exports/timelines/OrionEp11_timeline_from_csv.xml` の変換フローも Legacy スクリプトで検証済み。  
  - `scripts/csv_to_fcpx7_from_timeline.py` は音声ファイルを ffprobe でプローブし、<in>/<out> にサンプル単位（24kHz）を出力するよう改修済み。Resolve での赤アンダーラインは解消。  
  - Bracket 見出し `【00:00-00:30】` は読み上げ対象外に調整済み（2025-02修正）。  
  - Gemini TTS 上限に接近中。再生成の際は `audio/` を削除すると全再合成になるため注意。  
  - `scripts/srt_merge.py` は複数行 SRT を1行ずつ展開してマッチングするよう改修済み。今後の変更時は意図を維持。  
  - Ep12 では一部音声に不要語（頭出しノイズ）が残存。Gemini 側のレスポンス由来。再収録時は `orion_tts_generator.py` でのリトライロジック確認。
- 引き継ぎタスク  
  - [ ] Gemini API キーと Google Cloud 認証情報 (.env) の棚卸し。  
  - [ ] 長尺セグメントでの句読点最適化（SSML `<break>` を字幕側に置き換えるロジック見直し）。  
  - [ ] `orion_epXX_script.csv` の自動生成スクリプト整備（Ep12 では仮置き空ファイル使用中）。  
  - [ ] 章見出し（`#` / `【】` など）から始まるセグメントに 3 秒リードインを強制する処理を `timeline.calculate_timeline` / 旧レガシー CSV 生成の双方に実装し、SRT/CSV/XML へ反映する。

---

3. DaVinci Resolve 画像タグ / メタデータ
---------------------------------------

- 仕様 / 運用ガイド: `projects/Orioncommon/automation.md`  
  - Power Bin/Smart Bin 作成手順、メタデータ一括インポート、First Actions など編集ワークフローを網羅。  
  - スクリプト化すべきタスク（メタデータ書き込み、iStock 検索クエリ抽出 等）が列挙されている。
- 統制語彙: `projects/Orioncommon/data/controlled_vocab.yaml`  
  - `S:`（シーン／場所）、`M:`（モチーフ）、`E:`（感情）などカテゴリ別タグ一覧。  
  - Resolve メディアプールの `Keywords` に同じ接頭辞で入力する想定。  
  - CSV ドラフト: `projects/Orioncommon/assistantreport.md` 4章にタグ付け候補一覧（最終採用タグは未確定）。
- Resolve 自動化方針  
  - Python/Lua スクリプトで CSV からクリップ特定 → `Keywords` / `Comments` を追記する構想。  
  - 現時点ではテンプレ CSV の整備が先行。スクリプト本体は要実装。  
  - Premiere で生成した FCPXML を Resolve に取り込むワークフローも確保済み（`nle_autoedit/specs/common/data_contract.md`）。
- 引き継ぎタスク  
  - [ ] `controlled_vocab.yaml` を基に実運用タグセットを決定。Power Bin 条件と整合させる。  
  - [ ] Resolve スクリプト雛形（メタデータ一括適用）を `projects/Orioncommon/scripts/` などに追加。  
  - [ ] 既存素材にタグを当てる検証（小規模プロジェクトで試験）。

---

その他メモ
----------

- リポジトリルール  
  - Python 3.11 想定。`python3` は 3.13 を指す環境があるため `python3.11` を明示。  
  - `.env` で API キー（`GEMINI_API_KEY` など）を読み込む仕組み。引き継ぎ時に再設定必須。  
  - `scripts/run_tts_pipeline.py` は `--skip-xml` 等のフラグを持つが、将来的にはサブコマンド分割を検討。  
  - `projects/OrionEpXX/exports/` 内に旧ファイルが残りがち。パイプライン完走後に不要物を手動で整理。

- 未確認（要フォロー）  
  - Premiere パネルの署名手順 / インストールガイド（未着手）。  
  - DaVinci Resolve 用画像タグ CSV の最終版。`assistantreport.md` のドラフト段階。  
  - Gemini TTS の音声トリミング（先頭無音/ノイズ除去）ワークフロー。自動化タスクとして残課題。

不明点は `projects/Orioncommon/` 以下の共通資料を最初に確認し、必要に応じて `scripts/` ディレクトリの既存ツールを参照してください。
